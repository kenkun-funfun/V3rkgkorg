<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>JSONメーカー</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      color: #333;
      transition: background 0.2s ease;
    }

    body.drag-active {
      background: #eef;
    }

    input,
    button {
      padding: 0.5rem;
      font-size: 1rem;
    }

    #dropzone {
      margin-top: 1rem;
      border: 2px dashed #666;
      padding: 2rem;
      background: #fff;
      text-align: center;
      cursor: pointer;
    }

    #imageList {
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 0.5rem;
    }

    .image-item {
      font-size: 0.9rem;
      margin: 4px 0;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    #stats {
      margin-top: 1rem;
      font-weight: bold;
    }

    #downloadBtn {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      position: sticky;
      bottom: 1rem;
    }

    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      display: none;
      z-index: 1000;
    }

    #description {
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <h1>JSONメーカー</h1>
  <div style="margin-bottom: 1rem;">
    <a href="https://www.rkgk.org" style="
    display: inline-block;
    padding: 0.4rem 0.8rem;
    background: #eee;
    color: #333;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    border: 1px solid #ccc;
  ">
      ← RKGK.ORG に戻る
    </a>
  </div>

  <div id="description"
    style="background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; line-height: 1.6; font-size: 0.95rem;">

    <p><strong>JSONメーカーは、インターネット上の画像をBase64に変換し、RKGK.ORGで使用できるJSONファイルを生成するためのアプリです。</strong></p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      💡 <strong>ブラウザで表示されている画像を、そのままこのページの任意の場所にドラッグ＆ドロップするだけで動作します。</strong><br />
      画像をダウンロードする必要はなく、閲覧中のウェブページから直接取り込めるのが特長です。<br />
      ブラウザを2つ開いてドラッグドロップすると使いやすいと思います。PC操作を前提としています。<br />
    </p>

    <p
      style="margin-top: 0.75rem; color: #b00020; font-weight: bold; background: #fff0f0; padding: 0.5rem; border-left: 4px solid #b00020;">
      📝 たとえば<a href="https://unsplash.com" target="_blank" rel="noopener noreferrer" style="color: #3366cc; text-decoration: underline;">Unsplash</a> のような画像サイトでは、一覧に表示されている画像はうまく変換できないことがあります。<br />
      このような場合は、画像の詳細ページを開いて、該当画像をドラッグしてください。
    </p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      💡 このアプリで作成したJSONファイルの公開・配布については、元画像の利用規約にご注意ください。
    </p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      💡 <strong>Base64変換とは？</strong><br />
      画像をテキスト形式に変換する方法です。これにより、画像をJSONファイル内にそのまま埋め込めます。
    </p>

  </div>



  <label>カテゴリ名: <input type="text" id="categoryInput" placeholder="例: 猫" /></label>

  <div id="dropzone">
    ここに画像をドロップ または クリックして選択
    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #d00; font-weight: bold;">
      ※このページのどこにドロップしても画像は追加されます
    </div>
  </div>

  <div id="stats">成功: 0件 / 失敗: 0件</div>
  <div id="imageList"></div>

  <button id="downloadBtn">JSONをダウンロード</button>
  <div id="toast">✅ JSONをダウンロードしました</div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput') || (() => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.style.display = 'none';
      document.body.appendChild(input);
      return input;
    })();
    const categoryInput = document.getElementById('categoryInput');
    const imageList = document.getElementById('imageList');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    const stats = document.getElementById('stats');

    const images = [];
    let successCount = 0;
    let errorCount = 0;

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => e.preventDefault());
    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      await handleFiles(e.dataTransfer.files);
    });

    // 全画面ドロップ対応
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', async (e) => {
      e.preventDefault();
      document.body.classList.remove('drag-active');
      if (e.dataTransfer?.files?.length) {
        await handleFiles(e.dataTransfer.files);
      }
    });

    // 背景ハイライト
    document.addEventListener('dragenter', () => {
      document.body.classList.add('drag-active');
    });
    document.addEventListener('dragleave', (e) => {
      if (!e.relatedTarget || e.relatedTarget === document.body) {
        document.body.classList.remove('drag-active');
      }
    });

    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function updateStats() {
      stats.textContent = `成功: ${successCount}件 / 失敗: ${errorCount}件`;
    }

    async function handleFiles(files) {
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        try {
          const base64 = await resizeAndConvertToBase64(file, 1080, 1350);
          if (!base64) throw new Error('Base64変換失敗');
          const hash = await generateHash(base64);
          images.push({ base64, hash });

          const div = document.createElement('div');
          div.className = 'image-item success';
          div.textContent = `✅ ${file.name} - ${hash.slice(0, 10)}...`;
          imageList.appendChild(div);
          successCount++;
        } catch (err) {
          const div = document.createElement('div');
          div.className = 'image-item error';
          div.textContent = `❌ ${file.name} - 変換失敗`;
          imageList.appendChild(div);
          console.error('変換エラー:', file.name, err);
          errorCount++;
        }
        updateStats();
      }
    }

    function resizeAndConvertToBase64(file, maxWidth, maxHeight) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let { width, height } = img;
          const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
          width *= ratio;
          height *= ratio;
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          }, 'image/webp', 0.8);
        };
        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.readAsDataURL(file);
      });
    }

    async function generateHash(base64) {
      const data = new TextEncoder().encode(base64);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    downloadBtn.addEventListener('click', () => {
      const category = categoryInput.value.trim();
      if (!category) {
        alert('カテゴリ名を入力してください');
        return;
      }
      if (images.length === 0) {
        alert('画像がありません');
        return;
      }
      const data = {
        version: 'v1',
        data: {
          [category]: {
            images
          }
        }
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cat_${category}.json`;
      a.click();
      URL.revokeObjectURL(url);

      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    });
  </script>
</body>

</html>