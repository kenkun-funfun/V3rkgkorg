<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>JSONãƒ¡ãƒ¼ã‚«ãƒ¼</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      color: #333;
      transition: background 0.2s ease;
    }

    body.drag-active {
      background: #eef;
    }

    input,
    button {
      padding: 0.5rem;
      font-size: 1rem;
    }

    #dropzone {
      margin-top: 1rem;
      border: 2px dashed #666;
      padding: 2rem;
      background: #fff;
      text-align: center;
      cursor: pointer;
    }

    #imageList {
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 0.5rem;
    }

    .image-item {
      font-size: 0.9rem;
      margin: 4px 0;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    #stats {
      margin-top: 1rem;
      font-weight: bold;
    }

    #downloadBtn {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      position: sticky;
      bottom: 1rem;
    }

    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      display: none;
      z-index: 1000;
    }

    #description {
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <h1>JSONãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
  <div style="margin-bottom: 1rem;">
    <a href="https://www.rkgk.org" style="
    display: inline-block;
    padding: 0.4rem 0.8rem;
    background: #eee;
    color: #333;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    border: 1px solid #ccc;
  ">
      â† RKGK.ORG ã«æˆ»ã‚‹
    </a>
  </div>

  <div id="description"
    style="background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; line-height: 1.6; font-size: 0.95rem;">

    <p><strong>JSONãƒ¡ãƒ¼ã‚«ãƒ¼ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ç”»åƒã‚’Base64ã«å¤‰æ›ã—ã€RKGK.ORGã§ä½¿ç”¨ã§ãã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªã§ã™ã€‚</strong></p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      ğŸ’¡ <strong>ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã‚’ã€ãã®ã¾ã¾ã“ã®ãƒšãƒ¼ã‚¸ã®ä»»æ„ã®å ´æ‰€ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã ã‘ã§å‹•ä½œã—ã¾ã™ã€‚</strong><br />
      ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ã¯ãªãã€é–²è¦§ä¸­ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‹ã‚‰ç›´æ¥å–ã‚Šè¾¼ã‚ã‚‹ã®ãŒç‰¹é•·ã§ã™ã€‚<br />
      ãƒ–ãƒ©ã‚¦ã‚¶ã‚’2ã¤é–‹ã„ã¦ãƒ‰ãƒ©ãƒƒã‚°ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã¨ä½¿ã„ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚PCæ“ä½œã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚<br />
    </p>

    <p
      style="margin-top: 0.75rem; color: #b00020; font-weight: bold; background: #fff0f0; padding: 0.5rem; border-left: 4px solid #b00020;">
      ğŸ“ ãŸã¨ãˆã°<a href="https://unsplash.com" target="_blank" rel="noopener noreferrer" style="color: #3366cc; text-decoration: underline;">Unsplash</a> ã®ã‚ˆã†ãªç”»åƒã‚µã‚¤ãƒˆã§ã¯ã€ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã¯ã†ã¾ãå¤‰æ›ã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br />
      ã“ã®ã‚ˆã†ãªå ´åˆã¯ã€ç”»åƒã®è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã€è©²å½“ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„ã€‚
    </p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      ğŸ’¡ ã“ã®ã‚¢ãƒ—ãƒªã§ä½œæˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã®å…¬é–‹ãƒ»é…å¸ƒã«ã¤ã„ã¦ã¯ã€å…ƒç”»åƒã®åˆ©ç”¨è¦ç´„ã«ã”æ³¨æ„ãã ã•ã„ã€‚
    </p>

    <p style="margin-top: 0.75rem; color: #555; background: #f9f9f9; padding: 0.5rem; border-left: 4px solid #ccc;">
      ğŸ’¡ <strong>Base64å¤‰æ›ã¨ã¯ï¼Ÿ</strong><br />
      ç”»åƒã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç”»åƒã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ãã®ã¾ã¾åŸ‹ã‚è¾¼ã‚ã¾ã™ã€‚
    </p>

  </div>



  <label>ã‚«ãƒ†ã‚´ãƒªå: <input type="text" id="categoryInput" placeholder="ä¾‹: çŒ«" /></label>

  <div id="dropzone">
    ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #d00; font-weight: bold;">
      â€»ã“ã®ãƒšãƒ¼ã‚¸ã®ã©ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚‚ç”»åƒã¯è¿½åŠ ã•ã‚Œã¾ã™
    </div>
  </div>

  <div id="stats">æˆåŠŸ: 0ä»¶ / å¤±æ•—: 0ä»¶</div>
  <div id="imageList"></div>

  <button id="downloadBtn">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <div id="toast">âœ… JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput') || (() => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.style.display = 'none';
      document.body.appendChild(input);
      return input;
    })();
    const categoryInput = document.getElementById('categoryInput');
    const imageList = document.getElementById('imageList');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    const stats = document.getElementById('stats');

    const images = [];
    let successCount = 0;
    let errorCount = 0;

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => e.preventDefault());
    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      await handleFiles(e.dataTransfer.files);
    });

    // å…¨ç”»é¢ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', async (e) => {
      e.preventDefault();
      document.body.classList.remove('drag-active');
      if (e.dataTransfer?.files?.length) {
        await handleFiles(e.dataTransfer.files);
      }
    });

    // èƒŒæ™¯ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    document.addEventListener('dragenter', () => {
      document.body.classList.add('drag-active');
    });
    document.addEventListener('dragleave', (e) => {
      if (!e.relatedTarget || e.relatedTarget === document.body) {
        document.body.classList.remove('drag-active');
      }
    });

    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function updateStats() {
      stats.textContent = `æˆåŠŸ: ${successCount}ä»¶ / å¤±æ•—: ${errorCount}ä»¶`;
    }

    async function handleFiles(files) {
      for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        try {
          const base64 = await resizeAndConvertToBase64(file, 1080, 1350);
          if (!base64) throw new Error('Base64å¤‰æ›å¤±æ•—');
          const hash = await generateHash(base64);
          images.push({ base64, hash });

          const div = document.createElement('div');
          div.className = 'image-item success';
          div.textContent = `âœ… ${file.name} - ${hash.slice(0, 10)}...`;
          imageList.appendChild(div);
          successCount++;
        } catch (err) {
          const div = document.createElement('div');
          div.className = 'image-item error';
          div.textContent = `âŒ ${file.name} - å¤‰æ›å¤±æ•—`;
          imageList.appendChild(div);
          console.error('å¤‰æ›ã‚¨ãƒ©ãƒ¼:', file.name, err);
          errorCount++;
        }
        updateStats();
      }
    }

    function resizeAndConvertToBase64(file, maxWidth, maxHeight) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          let { width, height } = img;
          const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
          width *= ratio;
          height *= ratio;
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          }, 'image/webp', 0.8);
        };
        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.readAsDataURL(file);
      });
    }

    async function generateHash(base64) {
      const data = new TextEncoder().encode(base64);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    downloadBtn.addEventListener('click', () => {
      const category = categoryInput.value.trim();
      if (!category) {
        alert('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (images.length === 0) {
        alert('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      const data = {
        version: 'v1',
        data: {
          [category]: {
            images
          }
        }
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cat_${category}.json`;
      a.click();
      URL.revokeObjectURL(url);

      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    });
  </script>
</body>

</html>